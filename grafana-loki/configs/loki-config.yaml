# =============================================================================
# Grafana Loki Configuration - Oracle01 (Centralized Log Aggregation)
# =============================================================================
# Purpose: Store and query logs from all infrastructure
# Server: oracle01 (10.0.206.10) - 10GB RAM
# Receives from: Alloy agents on oracle01 + oracle02
# =============================================================================

auth_enabled: false

server:
  http_listen_port: 3100
  grpc_listen_port: 9095
  log_level: info

common:
  instance_addr: 127.0.0.1
  path_prefix: /loki
  storage:
    filesystem:
      chunks_directory: /loki/chunks
      rules_directory: /loki/rules
  replication_factor: 1
  ring:
    kvstore:
      store: inmemory

# =============================================================================
# LIMITS CONFIGURATION - Increased for Multiple Servers
# =============================================================================
# These limits are TEMPORARY while fixing cardinality.
# After Alloy migration with low-cardinality labels, you can reduce these.

limits_config:
  # Ingestion limits
  ingestion_rate_mb: 32                  # Increased from default 4MB
  ingestion_burst_size_mb: 48            # Increased from default 6MB
  per_stream_rate_limit: 10MB            # Increased from default 3MB
  per_stream_rate_limit_burst: 20MB     # Increased from default 15MB

  # Stream limits - CRITICAL FOR AVOIDING 429 ERRORS
  max_streams_per_user: 50000            # Increased from default 10,000
  max_global_streams_per_user: 100000   # Increased from default 50,000

  # Query limits
  max_query_length: 721h                 # 30 days
  max_query_lookback: 0h                 # No limit (use retention instead)
  max_entries_limit_per_query: 10000    # Increased from default 5,000
  max_query_series: 10000                # Increased from default 500

  # Sample/Log entry limits
  reject_old_samples: true
  reject_old_samples_max_age: 168h      # 7 days
  max_line_size: 256KB                  # Increased from default 256KB
  max_line_size_truncate: false         # Don't truncate, reject instead

  # Cardinality limits (prevents label explosion)
  cardinality_limit: 100000             # Max unique label combinations
  max_streams_matchers_per_query: 1000  # Limits query complexity

  # Split queries (improves performance)
  split_queries_by_interval: 24h        # Split long queries into 24h chunks

# =============================================================================
# SCHEMA CONFIGURATION
# =============================================================================

schema_config:
  configs:
    - from: 2024-01-01
      store: tsdb                        # Time Series Database index
      object_store: filesystem           # Local filesystem storage
      schema: v13                        # Latest schema version
      index:
        prefix: index_
        period: 24h                      # New index every 24 hours

# =============================================================================
# STORAGE CONFIGURATION
# =============================================================================

storage_config:
  tsdb_shipper:
    active_index_directory: /loki/tsdb-index
    cache_location: /loki/tsdb-cache
    cache_ttl: 24h                       # Cache indices for 24 hours

  filesystem:
    directory: /loki/chunks

# =============================================================================
# COMPACTOR (Data Retention & Cleanup)
# =============================================================================

compactor:
  working_directory: /loki/compactor
  compaction_interval: 10m               # Run compaction every 10 minutes
  retention_enabled: true                # Enable automatic deletion of old data
  retention_delete_delay: 2h             # Wait 2h before deleting
  retention_delete_worker_count: 150     # Parallel workers for deletion
  delete_request_store: filesystem       # Required when retention is enabled

# =============================================================================
# CHUNK STORE (Chunk-level Configuration)
# =============================================================================

chunk_store_config:
  chunk_cache_config:
    embedded_cache:
      enabled: true
      max_size_mb: 1024                  # 1GB chunk cache
      ttl: 1h

# =============================================================================
# TABLE MANAGER (Index Retention)
# =============================================================================

table_manager:
  retention_deletes_enabled: true
  retention_period: 720h                 # 30 days retention

# =============================================================================
# QUERY FRONTEND (Optional - Improves Query Performance)
# =============================================================================

query_range:
  align_queries_with_step: true          # Align queries to metric intervals
  max_retries: 5                         # Retry failed queries
  cache_results: true                    # Cache query results
  results_cache:
    cache:
      embedded_cache:
        enabled: true
        max_size_mb: 512                 # 512MB query result cache
        ttl: 24h

# =============================================================================
# INGESTER (In-Memory Log Processing)
# =============================================================================

ingester:
  lifecycler:
    address: 127.0.0.1
    ring:
      kvstore:
        store: inmemory
      replication_factor: 1
    final_sleep: 0s

  chunk_idle_period: 5m                  # Flush chunks after 5m idle
  chunk_block_size: 262144               # 256KB chunks
  chunk_target_size: 1572864             # Target 1.5MB before flushing
  chunk_retain_period: 30s               # Keep chunks in memory for 30s

  wal:
    enabled: true                        # Write-Ahead Log for crash recovery
    dir: /loki/wal
    checkpoint_duration: 5m
    flush_on_shutdown: true
    replay_memory_ceiling: 4GB           # Max memory for WAL replay

# =============================================================================
# RUNTIME CONFIGURATION
# =============================================================================

runtime_config:
  file: /etc/loki/runtime.yaml           # Optional runtime config

# =============================================================================
# DEPLOYMENT NOTES
# =============================================================================
# 1. Mount this file to /etc/loki/loki-config.yaml in the Loki container
# 2. Update docker-compose to use: -config.file=/etc/loki/loki-config.yaml
# 3. Create required directories:
#      - /loki/chunks
#      - /loki/tsdb-index
#      - /loki/tsdb-cache
#      - /loki/wal
#      - /loki/compactor
# 4. After Alloy migration with low-cardinality labels, you can reduce:
#      - max_streams_per_user to 10,000
#      - max_global_streams_per_user to 20,000
# 5. Monitor stream count:
#      curl -s "http://localhost:3100/loki/api/v1/streams" | jq '. | length'
# =============================================================================
